<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase debug log level
        setLogLevel('debug');

        // Check if Firebase variables are defined and set up
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth ---
        let app, db, auth;
        let transactionsRef;

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            console.log('User is signed in:', user.uid);
                            document.getElementById('userIdDisplay').textContent = user.uid;
                            transactionsRef = collection(db, `artifacts/${appId}/users/${user.uid}/transactions`);
                            resolve();
                        } else {
                            console.log('No user signed in. Attempting to sign in...');
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        unsubscribe();
                    });
                });
                
                startRealtimeListener();
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('loadingSpinner').textContent = "Failed to load app. Check console for details.";
            }
        }

        function startRealtimeListener() {
            onSnapshot(transactionsRef, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentTab = document.querySelector('.tab-button.bg-blue-600').dataset.view;
                renderTransactions(transactions, currentTab);
                updateSummary(transactions);
            }, (error) => {
                console.error("Failed to listen for real-time updates:", error);
            });
        }
        
        // --- UI & Data Manipulation ---
        let allTransactions = [];

        function renderTransactions(transactions, view) {
            allTransactions = transactions;
            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            
            const now = new Date();
            let filteredTransactions = [];

            if (view === 'daily') {
                filteredTransactions = transactions.filter(t => {
                    const date = new Date(t.timestamp.toDate());
                    return date.getDate() === now.getDate() &&
                           date.getMonth() === now.getMonth() &&
                           date.getFullYear() === now.getFullYear();
                });
            } else if (view === 'monthly') {
                filteredTransactions = transactions.filter(t => {
                    const date = new Date(t.timestamp.toDate());
                    return date.getMonth() === now.getMonth() &&
                           date.getFullYear() === now.getFullYear();
                });
            } else if (view === 'yearly') {
                filteredTransactions = transactions.filter(t => {
                    const date = new Date(t.timestamp.toDate());
                    return date.getFullYear() === now.getFullYear();
                });
            }
            
            if (filteredTransactions.length === 0) {
                list.innerHTML = `<li class="text-gray-500 text-center py-4">No transactions found for this period.</li>`;
                return;
            }

            const sortedTransactions = filteredTransactions.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

            sortedTransactions.forEach(t => {
                const listItem = document.createElement('li');
                listItem.className = `flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border-l-4 ${t.type === 'income' ? 'border-green-500' : 'border-red-500'}`;
                
                const formattedAmount = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(t.amount);
                const icon = t.type === 'income' ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500';
                
                listItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${icon} mr-4"></i>
                        <div>
                            <p class="font-semibold text-gray-800">${t.description}</p>
                            <p class="text-xs text-gray-500">${new Date(t.timestamp.toDate()).toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="font-bold ${t.type === 'income' ? 'text-green-500' : 'text-red-500'}">${formattedAmount}</p>
                        <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors" data-id="${t.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(listItem);
            });
            addDeleteListeners();
        }

        function updateSummary(transactions) {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalBalance = totalIncome - totalExpenses;

            document.getElementById('totalBalance').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalBalance);
            document.getElementById('totalIncome').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalIncome);
            document.getElementById('totalExpenses').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalExpenses);
        }

        async function addTransaction(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.description.value.trim();
            const amount = parseFloat(form.amount.value);
            const type = form.type.value;

            if (!description || isNaN(amount) || amount <= 0) {
                // Use a custom modal or message box instead of alert()
                const messageBox = document.getElementById('messageBox');
                messageBox.textContent = "Please enter a valid description and amount.";
                messageBox.classList.remove('hidden');
                setTimeout(() => messageBox.classList.add('hidden'), 3000);
                return;
            }

            try {
                await addDoc(transactionsRef, {
                    description: description,
                    amount: amount,
                    type: type,
                    timestamp: new Date()
                });
                form.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }
        
        async function deleteTransaction(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/transactions`, id));
            } catch (error) {
                console.error("Error removing document: ", error);
            }
        }

        function addDeleteListeners() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const transactionId = e.currentTarget.dataset.id;
                    deleteTransaction(transactionId);
                };
            });
        }
        
        function handleTabClick(e) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            e.target.classList.remove('bg-gray-200', 'text-gray-700');
            e.target.classList.add('bg-blue-600', 'text-white');
            
            const view = e.target.dataset.view;
            renderTransactions(allTransactions, view);
        }

        // --- Event Listeners and Initial Setup ---
        window.addEventListener('load', () => {
            initFirebase();
            document.getElementById('addTransactionForm').addEventListener('submit', addTransaction);
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', handleTabClick);
            });
        });

    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Loading Screen -->
    <div id="loadingSpinner" class="flex flex-col items-center justify-center space-y-4 text-gray-600">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
        <p class="text-lg">Loading your tracker...</p>
    </div>

    <!-- Main App Content -->
    <div id="appContent" class="container mx-auto max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8 hidden">
        
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Finance Tracker</h1>
            <p class="text-sm text-gray-500">
                User ID: <span id="userIdDisplay" class="font-mono text-xs break-all"></span>
            </p>
        </div>

        <!-- Summary Card -->
        <div class="bg-blue-500 text-white rounded-2xl p-6 shadow-lg mb-8">
            <h2 class="text-lg font-semibold mb-2">Total Balance</h2>
            <p id="totalBalance" class="text-4xl font-bold">$0.00</p>
            <div class="flex justify-between mt-4 text-sm font-medium">
                <div>
                    <h3 class="opacity-80">Total Income</h3>
                    <p id="totalIncome" class="text-xl font-semibold text-green-200">$0.00</p>
                </div>
                <div>
                    <h3 class="opacity-80">Total Expenses</h3>
                    <p id="totalExpenses" class="text-xl font-semibold text-red-200">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Add Transaction Form -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add New Transaction</h2>
            <form id="addTransactionForm" class="grid md:grid-cols-3 gap-4">
                <div class="col-span-3 md:col-span-1">
                    <label for="description" class="block text-gray-700 font-medium mb-1">Description</label>
                    <input type="text" id="description" name="description" placeholder="e.g., Groceries" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200 focus:outline-none transition-shadow">
                </div>
                <div class="col-span-3 md:col-span-1">
                    <label for="amount" class="block text-gray-700 font-medium mb-1">Amount ($)</label>
                    <input type="number" id="amount" name="amount" placeholder="e.g., 50.00" step="0.01" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200 focus:outline-none transition-shadow">
                </div>
                <div class="col-span-3 md:col-span-1">
                    <label for="type" class="block text-gray-700 font-medium mb-1">Type</label>
                    <select id="type" name="type" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200 focus:outline-none transition-shadow">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="col-span-3">
                    <button type="submit"
                        class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                        Add Transaction
                    </button>
                </div>
            </form>
            <div id="messageBox" class="hidden mt-4 bg-red-100 text-red-700 p-3 rounded-lg text-center"></div>
        </div>
        
        <!-- Transaction List -->
        <div>
            <div class="flex justify-center mb-6 space-x-2">
                <button data-view="daily" class="tab-button bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition-colors hover:bg-blue-700">Daily</button>
                <button data-view="monthly" class="tab-button bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full shadow transition-colors hover:bg-gray-300">Monthly</button>
                <button data-view="yearly" class="tab-button bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full shadow transition-colors hover:bg-gray-300">Yearly</button>
            </div>
            
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transactions</h2>
            <ul id="transactionList" class="space-y-4">
                <!-- Transaction items will be rendered here by JavaScript -->
            </ul>
        </div>
    </div>
</body>
</html>
